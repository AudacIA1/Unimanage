{% extends 'base.html' %}
{% load status_tags %}

{% block title %}Panel de Reportes - Sistema de Activos{% endblock %}

{% block extra_head %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        .card {
          background: #fff;
          border-radius: 12px;
          box-shadow: 0 2px 6px rgba(0,0,0,0.05);
          padding: 20px;
          margin-bottom: 20px;
        }
        .status {
            font-weight: bold;
        }
        .status.approved {
          color: green;
        }
        .status.pending {
          color: #F59E0B;
        }
        .status.rejected {
          color: red;
        }
        .btn-primary, .btn-secondary {
          margin-top: 10px;
          padding: 8px 12px;
          border: none;
          border-radius: 6px;
          cursor: pointer;
        }
        .btn-primary { background-color: #3b82f6; color: #fff; }
        .btn-secondary { background-color: #f3f4f6; color: #333; }
    </style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <header class="mb-8">
        <h1 class="text-4xl font-bold text-primary dark:text-primary tracking-tight">Panel de Reportes de Activos</h1>
        <p class="text-secondary dark:text-secondary mt-1">Resumen completo del estado de los activos y categor√≠as.</p>
    </header>

    <!-- Main Content -->
    <div class="container mx-auto px-4 mb-16">

        <!-- General Metrics Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-8">
            <div class="bg-white dark:bg-slate-800 rounded-xl shadow-md p-5 text-center">
                <h3 class="text-lg font-bold text-gray-700 dark:text-gray-300">Total Activos</h3>
                <p class="text-4xl font-bold text-dark dark:text-white">{{ total_assets }}</p>
            </div>
            <div class="bg-white dark:bg-slate-800 rounded-xl shadow-md p-5 text-center">
                <h3 class="text-lg font-bold text-gray-700 dark:text-gray-300">Disponibles</h3>
                <p class="text-4xl font-bold text-primary dark:text-primary">{{ available_assets }}</p>
            </div>
            <div class="bg-white dark:bg-slate-800 rounded-xl shadow-md p-5 text-center">
                <h3 class="text-lg font-bold text-gray-700 dark:text-gray-300">En Uso</h3>
                <p class="text-4xl font-bold text-status_blue dark:text-status_blue">{{ in_use_assets }}</p>
            </div>
            <div class="bg-white dark:bg-slate-800 rounded-xl shadow-md p-5 text-center">
                <h3 class="text-lg font-bold text-gray-700 dark:text-gray-300">En Mantenimiento</h3>
                <p class="text-4xl font-bold text-status_yellow dark:text-status_yellow">{{ maintenance_assets }}</p>
            </div>
            <div class="bg-white dark:bg-slate-800 rounded-xl shadow-md p-5 text-center">
                <h3 class="text-lg font-bold text-gray-700 dark:text-gray-300">Categor√≠as</h3>
                <p class="text-4xl font-bold text-dark dark:text-white">{{ total_categories }}</p>
            </div>
        </div>


        <!-- Charts Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <div class="bg-white dark:bg-slate-800 rounded-xl shadow-md p-5">
                <h2 class="text-xl font-semibold text-dark dark:text-white mb-4">Distribuci√≥n de Activos por Estado</h2>
                <canvas id="assetStatusChart"></canvas>
            </div>
            <div class="bg-white dark:bg-slate-800 rounded-xl shadow-md p-5">
                <h2 class="text-xl font-semibold text-dark dark:text-white mb-4">Activos por Categor√≠a</h2>
                <canvas id="assetCategoryChart"></canvas>
            </div>
        </div>

        <!-- Distribuci√≥n por Categor√≠as -->
        <div class="mb-8">
            <div class="bg-white dark:bg-slate-800 rounded-xl shadow-md overflow-hidden">
                                        <div class="bg-dark dark:bg-slate-700 text-white px-5 py-3 font-semibold text-lg">
                                            <i class="fas fa-layer-group mr-2"></i> Distribuci√≥n por Categor√≠as de Activos
                                        </div>
                                        <div class="p-5 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">                    {% for item in data_by_category %}
                    <div class="bg-gray-100 dark:bg-gray-700 rounded-lg p-4 shadow">
                        <h3 class="text-lg font-bold mb-2 dark:text-white">{{ item.categoria }}</h3>
                        <p class="text-sm text-gray-700 dark:text-gray-300">Total: {{ item.total }}</p>
                        <div class="w-full bg-gray-300 dark:bg-gray-600 rounded-full h-4 mt-3 flex">
                            <div class="h-4 rounded-l-full" style="width: {{ item.disponibles_pct }}%; background-color: #10B981;"></div>
                            <div class="h-4" style="width: {{ item.en_uso_pct }}%; background-color: #3B82F6;"></div>
                            <div class="h-4 rounded-r-full" style="width: {{ item.mantenimiento_pct }}%; background-color: #F59E0B;"></div>
                        </div>
                        <div class="mt-3 text-sm">
                            <span class="text-primary dark:text-primary font-semibold">{{ item.disponibles }} disponibles</span> | 
                            <span class="text-status_blue dark:text-status_blue font-semibold">{{ item.en_uso }} en uso</span> | 
                            <span class="text-status_yellow dark:text-status_yellow font-semibold">{{ item.mantenimiento }} en mant.</span>
                        </div>
                    </div>
                    {% empty %}
                    <p class="col-span-4 text-center text-gray-500 dark:text-gray-400">No hay categor√≠as registradas.</p>
                    {% endfor %}
                </div>
            </div>
        </div>
        <!-- Checklist and Upcoming Events -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
          <div class="bg-white dark:bg-slate-800 rounded-xl shadow-md p-5">
            <h2 class="text-xl font-semibold text-dark dark:text-white mb-4">Pr√≥ximo Evento</h2>
            {% if nearest_event %}
              <h3 class="text-lg font-bold">{{ nearest_event.titulo }}</h3>
              <p class="text-sm text-gray-500 mb-4">{{ nearest_event.fecha_inicio|date:"d/m/Y H:i" }}</p>
              <p class="text-sm text-gray-700 dark:text-gray-300"><strong>Lugar:</strong> {{ nearest_event.lugar }}</p>
              <p class="text-sm text-gray-700 dark:text-gray-300"><strong>Responsable:</strong> {{ nearest_event.responsable }}</p>
              <p class="text-sm text-gray-700 dark:text-gray-300"><strong>Asistentes:</strong> {{ nearest_event.current_attendees }} / {{ nearest_event.max_attendees|default:"-" }}</p>
              <p class="text-sm text-gray-700 dark:text-gray-300"><strong>Entidad que asiste:</strong> {{ nearest_event.attending_entity|default:"-" }}</p>
              <h4 class="text-md font-semibold text-dark dark:text-white mt-4 mb-2">Checklist</h4>
              <form method="post">
                {% csrf_token %}
                {{ checklist_formset.management_form }}
                <div id="checklist-formset-container" class="space-y-4">
                  {% for form in checklist_formset %}
                    <div class="flex items-center justify-between p-4 bg-gray-100 dark:bg-gray-700 rounded-lg">
                      <div class="flex items-center space-x-4">
                        {{ form.is_checked }}
                        {{ form.description }}
                      </div>
                      {% if checklist_formset.can_delete %}
                        <div class="flex items-center">
                          {{ form.DELETE }}
                          <label for="{{ form.DELETE.id_for_label }}" class="ml-2 text-sm font-medium text-gray-700 dark:text-gray-300">Eliminar</label>
                        </div>
                      {% endif %}
                    </div>
                  {% endfor %}
                </div>
                <div class="flex justify-end space-x-4 mt-6">
                    <button type="button" id="add-checklist-item" class="px-4 py-2 text-sm font-medium text-white bg-primary rounded-lg hover:bg-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">A√±adir item</button>
                    <button type="submit" name="checklist_submit" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Guardar Checklist</button>
                </div>
                <template id="checklist-empty-form">
                    <div class="flex items-center justify-between p-4 bg-gray-100 dark:bg-gray-700 rounded-lg">
                      <div class="flex items-center space-x-4">
                        {{ checklist_formset.empty_form.is_checked }}
                        {{ checklist_formset.empty_form.description }}
                      </div>
                      {% if checklist_formset.can_delete %}
                        <div class="flex items-center">
                          {{ checklist_formset.empty_form.DELETE }}
                          <label for="{{ checklist_formset.empty_form.DELETE.id_for_label }}" class="ml-2 text-sm font-medium text-gray-700 dark:text-gray-300">Eliminar</label>
                        </div>
                      {% endif %}
                    </div>
                </template>
              </form>
            {% else %}
              <p>No hay eventos pr√≥ximos.</p>
            {% endif %}
          </div>
          <div class="bg-white dark:bg-slate-800 rounded-xl shadow-md p-5">
            <h2 class="text-xl font-semibold text-dark dark:text-white mb-4">Pr√≥ximos 5 Eventos</h2>
            {% if other_upcoming_events %}
              <ul class="space-y-4">
                {% for event in other_upcoming_events %}
                  <li class="border-b border-gray-200 dark:border-gray-700 pb-4 last:border-b-0">
                    <h3 class="text-md font-bold">{{ event.titulo }}</h3>
                    <p class="text-sm text-gray-500">{{ event.fecha_inicio|date:"d/m/Y H:i" }}</p>
                  </li>
                {% endfor %}
              </ul>
            {% else %}
              <p>No hay m√°s eventos pr√≥ximos.</p>
            {% endif %}
          </div>
        </div>
    <div class="card">
      <h2 class="text-lg font-semibold mb-2">üßæ Solicitudes recientes</h2>
      <ul>
        {% for r in recent_requests %}
          <li>{{ r.user.username }} pidi√≥ <strong>{{ r.asset.name }}</strong> <span class="status {{ r.get_status_display|status_to_class }}">{{ r.get_status_display }}</span></li>
        {% empty %}
          <p>No hay solicitudes recientes</p>
        {% endfor %}
      </ul>
      <a href="{% url 'request:request_list' %}"><button class="btn-secondary">Ver todas</button></a>
    </div>
</div>

        <!-- Last 10 Loans and Maintenances -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-12">
            <!-- Last 10 Loans -->
            <div class="bg-white dark:bg-slate-800 rounded-xl shadow-md overflow-hidden">
                <div class="bg-dark dark:bg-slate-700 text-white px-5 py-3 font-semibold text-lg">
                    <i class="fas fa-handshake mr-2"></i> √öltimos 10 Pr√©stamos
                </div>
                <div class="p-5">
                    {% if last_10_loans %}
                    <table id="loansTable" class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                        <thead class="bg-gray-50 dark:bg-slate-700">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Activo</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Usuario</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Fecha Pr√©stamo</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white dark:bg-slate-800 divide-y divide-gray-200 dark:divide-gray-700">
                            {% for loan in last_10_loans %}
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">{{ loan.asset.name }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">{{ loan.user.username }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">{{ loan.loan_date|date:"d/m/Y" }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <p class="text-center text-gray-500 dark:text-gray-400">No hay pr√©stamos recientes.</p>
                    {% endif %}
                </div>
            </div>

            <!-- Last 10 Maintenances -->
            <div class="bg-white dark:bg-slate-800 rounded-xl shadow-md overflow-hidden">
                <div class="bg-dark dark:bg-slate-700 text-white px-5 py-3 font-semibold text-lg">
                    <i class="fas fa-tools mr-2"></i> √öltimos 10 Mantenimientos
                </div>
                <div class="p-5">
                    {% if last_10_maintenances %}
                    <table id="maintenancesTable" class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                        <thead class="bg-gray-50 dark:bg-slate-700">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Activo</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Estado</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Fecha</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white dark:bg-slate-800 divide-y divide-gray-200 dark:divide-gray-700">
                            {% for maintenance in last_10_maintenances %}
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">{{ maintenance.asset.name }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">{{ maintenance.status }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">{{ maintenance.created_at|date:"d/m/Y" }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <p class="text-center text-gray-500 dark:text-gray-400">No hay mantenimientos recientes.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>



{% endblock %}

{% block extra_scripts %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    {% if checklist_formset %}
    const addChecklistItemButton = document.getElementById('add-checklist-item');
    if (addChecklistItemButton) {
      const checklistContainer = document.getElementById('checklist-formset-container');
      const emptyFormTemplate = document.getElementById('checklist-empty-form').innerHTML;
      const totalFormsInput = document.querySelector('#id_checklist-TOTAL_FORMS');
      let formNum = {{ checklist_formset.total_form_count }};

      addChecklistItemButton.addEventListener('click', function() {
        let newForm = emptyFormTemplate.replace(/__prefix__/g, formNum);
        checklistContainer.insertAdjacentHTML('beforeend', newForm);
        totalFormsInput.value = parseInt(totalFormsInput.value) + 1;
        formNum++;
      });
    }
    {% endif %}
    // Asset Status Chart (Doughnut Chart)
    const assetStatusCtx = document.getElementById('assetStatusChart').getContext('2d');
    new Chart(assetStatusCtx, {
        type: 'doughnut',
        data: {
            labels: {{ asset_status_labels|safe }},
            datasets: [{
                data: {{ asset_status_data|safe }},
                backgroundColor: [
                    '#10B981', // primary (Disponible)
                    '#3B82F6', // status_blue (En uso)
                    '#F59E0B', // status_yellow (En mantenimiento)
                ],
                hoverOffset: 4
            }]
        },
        options: {
            responsive: true,
            aspectRatio: 2, // Hace el gr√°fico m√°s ancho que alto
            plugins: {
                legend: {
                    position: 'top',
                },
                title: {
                    display: false,
                }
            }
        }
    });

    // Assets by Category Chart (Bar Chart)
    const assetCategoryCtx = document.getElementById('assetCategoryChart').getContext('2d');
    new Chart(assetCategoryCtx, {
        type: 'bar',
        data: {
            labels: {{ asset_category_labels|safe }},
            datasets: [{
                label: 'N√∫mero de Activos',
                data: {{ asset_category_data|safe }},
                backgroundColor: '#10B981',
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: false,
                },
                title: {
                    display: false,
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });
});
</script>
{% endblock %}
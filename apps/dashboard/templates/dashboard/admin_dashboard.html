{% extends 'base.html' %}
{% load status_tags %}

{% block title %}Panel de Reportes - Sistema de Activos{% endblock %}

{% block extra_head %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    {% endblock %}

{% block content %}
{{ entity_chart_data|json_script:"entity_chart_data" }}
{{ type_chart_data|json_script:"type_chart_data" }}
{{ status_summary|json_script:"status_summary_data" }}
{{ user_summary|json_script:"user_summary_data" }}

<div class="p-6 bg-gradient-to-br from-white to-slate-50 dark:from-slate-800 dark:to-slate-900 rounded-2xl shadow-lg border border-slate-100 dark:border-slate-700">
    <div class="flex items-center justify-between mb-8">
        <h1 class="text-3xl font-extrabold text-gray-900 dark:text-white tracking-tight">
        <h1 class="text-4xl font-bold text-primary dark:text-primary tracking-tight">Panel de Reportes</h1>
        </h1>
        <button class="px-4 py-2 bg-green-600 text-white rounded-lg shadow hover:bg-green-700 transition">
            <i class="fa-solid fa-download mr-1"></i> Exportar Reporte
        </button>
    </div>

    <!-- Main Content -->
    <div x-data="{ tab: 'resumen' }" class="space-y-6 container mx-auto px-4 mb-16">
        <div class="flex space-x-4 border-b pb-2">
            <button @click="tab='resumen'" :class="tab==='resumen' ? 'text-green-600 font-semibold' : 'text-gray-500'">Resumen</button>
            <button @click="tab='graficos'; $nextTick(() => updateCharts())" :class="tab==='graficos' ? 'text-green-600 font-semibold' : 'text-gray-500'">Gr√°ficos</button>
            <button @click="tab='eventos'" :class="tab==='eventos' ? 'text-green-600 font-semibold' : 'text-gray-500'">Eventos</button>
            <button @click="tab='historial'" :class="tab==='historial' ? 'text-green-600 font-semibold' : 'text-gray-500'">Historial</button>
        </div>

        <div x-show="tab==='resumen'" class="space-y-8">
            <!-- General Metrics Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                <div class="flex flex-col items-center justify-center p-6 bg-gradient-to-br from-green-50 to-white dark:from-slate-800 dark:to-slate-900 rounded-2xl shadow-md hover:shadow-xl transition-all border border-green-100 dark:border-slate-700">
                    <i class="fas fa-box-open text-green-500 text-3xl mb-2"></i>
                    <h3 class="text-sm font-semibold text-gray-600 dark:text-gray-400">Total Activos</h3>
                    <p class="text-4xl font-bold text-gray-900 dark:text-white">{{ total_assets }}</p>
                </div>
                <div class="flex flex-col items-center justify-center p-6 bg-gradient-to-br from-blue-50 to-white dark:from-slate-800 dark:to-slate-900 rounded-2xl shadow-md hover:shadow-xl transition-all border border-blue-100 dark:border-slate-700">
                    <i class="fas fa-check-circle text-primary text-3xl mb-2"></i>
                    <h3 class="text-sm font-semibold text-gray-600 dark:text-gray-400">Disponibles</h3>
                    <p class="text-4xl font-bold text-primary dark:text-primary">{{ available_assets }}</p>
                </div>
                <div class="flex flex-col items-center justify-center p-6 bg-gradient-to-br from-indigo-50 to-white dark:from-slate-800 dark:to-slate-900 rounded-2xl shadow-md hover:shadow-xl transition-all border border-indigo-100 dark:border-slate-700">
                    <i class="fas fa-cogs text-blue-500 text-3xl mb-2"></i>
                    <h3 class="text-sm font-semibold text-gray-600 dark:text-gray-400">En Uso</h3>
                    <p class="text-4xl font-bold text-blue-500 dark:text-blue-500">{{ in_use_assets }}</p>
                </div>
                <div class="flex flex-col items-center justify-center p-6 bg-gradient-to-br from-yellow-50 to-white dark:from-slate-800 dark:to-slate-900 rounded-2xl shadow-md hover:shadow-xl transition-all border border-yellow-100 dark:border-slate-700">
                    <i class="fas fa-tools text-yellow-500 text-3xl mb-2"></i>
                    <h3 class="text-sm font-semibold text-gray-600 dark:text-gray-400">En Mantenimiento</h3>
                    <p class="text-4xl font-bold text-yellow-500 dark:text-yellow-500">{{ maintenance_assets }}</p>
                </div>
                <div class="flex flex-col items-center justify-center p-6 bg-gradient-to-br from-gray-50 to-white dark:from-slate-800 dark:to-slate-900 rounded-2xl shadow-md hover:shadow-xl transition-all border border-gray-100 dark:border-slate-700">
                    <i class="fas fa-layer-group text-gray-500 text-3xl mb-2"></i>
                    <h3 class="text-sm font-semibold text-gray-600 dark:text-gray-400">Categor√≠as</h3>
                    <p class="text-4xl font-bold text-gray-900 dark:text-white">{{ total_categories }}</p>
                </div>
            </div>

            <!-- Pr√©stamos Vencidos -->
            <div class="p-6 bg-gradient-to-br from-white to-slate-50 dark:bg-[#1b2432] rounded-2xl shadow-lg border border-slate-100 dark:border-gray-700">
                <div class="bg-dark dark:bg-[#2b3548] text-white px-5 py-3 font-semibold text-lg rounded-t-xl">
                    <i class="fas fa-exclamation-triangle text-red-500 mr-2"></i> Pr√©stamos Vencidos
                </div>
                <div class="p-5">
                    {% if overdue_loans %}
                    <table class="min-w-full text-sm divide-y divide-gray-200 dark:divide-gray-700">
                        <thead class="bg-red-50 text-gray-600 uppercase text-xs dark:bg-[#2b3548] dark:text-gray-200">
                            <tr>
                                <th class="px-6 py-3 text-left"><i class="fas fa-box-open mr-2"></i>Activo</th>
                                <th class="px-6 py-3 text-left"><i class="fas fa-user mr-2"></i>Usuario</th>
                                <th class="px-6 py-3 text-left"><i class="fas fa-calendar-alt mr-2"></i>Fecha Vencimiento</th>
                                <th class="px-6 py-3 text-left"><i class="fas fa-clock mr-2"></i>D√≠as de Retraso</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200 dark:bg-slate-800 dark:divide-gray-700">
                            {% for loan in overdue_loans %}
                            <tr class="hover:bg-red-50 transition-all dark:hover:bg-[#253045]">
                                <td class="px-6 py-4 font-medium text-gray-900 dark:text-gray-100">{{ loan.asset.name }}</td>
                                <td class="px-6 py-4 text-gray-700 dark:text-gray-300">{{ loan.user.username }}</td>
                                <td class="px-6 py-4 text-gray-700 dark:text-gray-300">{{ loan.due_date|date:"d/m/Y" }}</td>
                                <td class="px-6 py-4 text-red-500 font-semibold">{{ loan.due_date|timeuntil:now }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <p class="text-center text-gray-500 dark:text-gray-400">No hay pr√©stamos vencidos.</p>
                    {% endif %}
                </div>
            </div>

            <!-- Distribuci√≥n por Categor√≠as -->
            <div class="p-6 bg-gradient-to-br from-white to-slate-50 dark:bg-[#1b2432] rounded-2xl shadow-lg border border-slate-100 dark:border-gray-700">
                <div class="bg-dark dark:bg-[#2b3548] text-white px-5 py-3 font-semibold text-lg rounded-t-xl">
                    <i class="fas fa-layer-group mr-2"></i> Distribuci√≥n por Categor√≠as de Activos
                </div>
                <div class="p-5 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    {% for item in data_by_category %}
                    <div class="bg-gray-100 dark:bg-[#253045] rounded-lg p-4 shadow">
                        <h3 class="text-lg font-bold mb-2 text-gray-800 dark:text-gray-200">{{ item.categoria }}</h3>
                        <p class="text-sm text-gray-700 dark:text-gray-300">Total: {{ item.total }}</p>
                        <div class="w-full bg-gray-300 dark:bg-gray-600 rounded-full h-4 mt-3 flex">
                            <div class="h-4 rounded-l-full" style="width: {{ item.disponibles_pct }}%; background-color: #10B981;"></div>
                            <div class="h-4" style="width: {{ item.en_uso_pct }}%; background-color: #2563EB;"></div>
                            <div class="h-4 rounded-r-full" style="width: {{ item.mantenimiento_pct }}%; background-color: #FBBF24;"></div>
                        </div>
                        <div class="mt-3 text-sm">
                            <span class="text-primary dark:text-green-400 font-semibold">{{ item.disponibles }} disponibles</span> |
                            <span class="text-blue-500 dark:text-blue-500 font-semibold">{{ item.en_uso }} en uso</span> |
                            <span class="text-yellow-500 dark:text-yellow-400 font-semibold">{{ item.mantenimiento }} en mant.</span>
                        </div>
                    </div>
                    {% empty %}
                                    <p class="col-span-4 text-center text-gray-500 dark:text-gray-400">No hay categor√≠as registradas.</p>
                                    {% endfor %}
                                </div>
                            </div>
                    
                          
                        </div>
        <div x-show="tab==='graficos'" class="space-y-8">
            <!-- Panel de controles: toggles, guardar, reset -->
            <div class="mb-6 flex flex-wrap items-center gap-3">
              <div class="flex items-center gap-2">
                <button id="saveDashboardBtn" class="px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700 transition">Guardar</button>
                <button id="resetDashboardBtn" class="px-3 py-1 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 transition">Reiniciar</button>
              </div>

              <div class="ml-auto flex items-center gap-4">
                <label class="flex items-center gap-2">
                  <input type="checkbox" class="chart-toggle" data-chart="chartStatus" checked>
                  <span class="text-sm">Estado</span>
                </label>
                <label class="flex items-center gap-2">
                  <input type="checkbox" class="chart-toggle" data-chart="chartCategory" checked>
                  <span class="text-sm">Categor√≠a</span>
                </label>
                <label class="flex items-center gap-2">
                  <input type="checkbox" class="chart-toggle" data-chart="chartEntity" checked>
                  <span class="text-sm">Eventos por Entidad</span>
                </label>
                <label class="flex items-center gap-2">
                  <input type="checkbox" class="chart-toggle" data-chart="chartType" checked>
                  <span class="text-sm">Tipo de Evento</span>
                </label>
                <label class="flex items-center gap-2">
                  <input type="checkbox" class="chart-toggle" data-chart="loanStatusChart" checked>
                  <span class="text-sm">Estado de Pr√©stamos</span>
                </label>
                <label class="flex items-center gap-2">
                  <input type="checkbox" class="chart-toggle" data-chart="loanUserChart" checked>
                  <span class="text-sm">Pr√©stamos por Usuario</span>
                </label>
              </div>
            </div>

            <!-- Contenedor reordenable de charts -->
            <div id="chartsContainer" class="grid grid-cols-1 lg:grid-cols-2 gap-8">
              <div class="chart-card p-6 rounded-2xl shadow-lg border transition-all duration-300 ease-in-out transform" data-id="chartStatus" id="chartStatus">
                <h3 class="font-semibold mb-4">Distribuci√≥n de Activos por Estado</h3>
                <canvas id="assetStatusChart"></canvas>
              </div>

              <div class="chart-card p-6 rounded-2xl shadow-lg border transition-all duration-300 ease-in-out transform" data-id="chartCategory" id="chartCategory">
                <h3 class="font-semibold mb-4">Activos por Categor√≠a</h3>
                <canvas id="assetCategoryChart"></canvas>
              </div>

              <div class="chart-card p-6 rounded-2xl shadow-lg border transition-all duration-300 ease-in-out transform" data-id="chartEntity" id="chartEntity">
                <h3 class="font-semibold mb-4">Eventos por Entidad</h3>
                <canvas id="entityChart"></canvas>
              </div>

              <div class="chart-card p-6 rounded-2xl shadow-lg border transition-all duration-300 ease-in-out transform" data-id="chartType" id="chartType">
                <h3 class="font-semibold mb-4">Distribuci√≥n por Tipo de Evento</h3>
                <canvas id="typeChart"></canvas>
              </div>

              <div class="chart-card p-6 rounded-2xl shadow-lg border transition-all duration-300 ease-in-out transform" data-id="loanStatusChart" id="loanStatusChart">
                <h3 class="font-semibold mb-4">Estado de Pr√©stamos</h3>
                <canvas id="loanStatusCanvas"></canvas>
              </div>

              <div class="chart-card p-6 rounded-2xl shadow-lg border transition-all duration-300 ease-in-out transform" data-id="loanUserChart" id="loanUserChart">
                <h3 class="font-semibold mb-4">Pr√©stamos por Usuario</h3>
                <canvas id="loanUserCanvas"></canvas>
              </div>
            </div>
        </div>

        <div x-show="tab==='eventos'" class="space-y-8">
            <!-- Checklist and Upcoming Events -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-gradient-to-r from-green-100 to-green-50 dark:from-green-800/30 dark:to-slate-800 p-5 rounded-2xl shadow-md border border-green-200 dark:border-green-700">
                    <div class="flex items-center mb-3">
                        <i class="fa-solid fa-calendar-day text-green-600 text-2xl mr-2"></i>
                        <h2 class="text-2xl font-bold text-green-800 dark:text-green-400">Pr√≥ximo Evento</h2>
                    </div>
                    {% if nearest_event %}
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">{{ nearest_event.titulo }}</h3>
                    <p class="text-sm text-gray-500 mb-4"><i class="fa-regular fa-clock mr-1"></i>{{ nearest_event.fecha_inicio|date:"d/m/Y H:i" }}</p>
                    <p class="text-sm text-gray-700 dark:text-gray-300"><strong>Lugar:</strong> {{ nearest_event.lugar }}</p>
                    <p class="text-sm text-gray-700 dark:text-gray-300"><strong>Responsable:</strong> {{ nearest_event.responsable }}</p>
                    <p class="text-sm text-gray-700 dark:text-gray-300"><strong>Entidad que asiste:</strong> {{ nearest_event.attending_entity|default:"-" }}</p>
                    <h4 class="text-lg font-semibold text-gray-700 dark:text-white mt-4 mb-2">Checklist</h4>
                    <form method="post">
                        {% csrf_token %}
                        {{ checklist_formset.management_form }}
                        <div id="checklist-formset-container" class="space-y-4">
                            {% for form in checklist_formset %}
                            <div class="flex items-center justify-between p-4 bg-gray-100 dark:bg-gray-700 rounded-lg">
                                <div class="flex items-center space-x-4">
                                    {{ form.is_checked }}
                                    {{ form.description }}
                                </div>
                                {% if checklist_formset.can_delete %}
                                <div class="flex items-center">
                                    {{ form.DELETE }}
                                    <label for="{{ form.DELETE.id_for_label }}" class="ml-2 text-sm font-medium text-gray-700 dark:text-gray-300">Eliminar</label>
                                </div>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                        <div class="flex justify-end space-x-4 mt-6">
                            <button type="button" id="add-checklist-item" class="px-4 py-2 text-sm font-medium text-white bg-primary rounded-lg hover:bg-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">A√±adir item</button>
                            <button type="submit" name="checklist_submit" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Guardar Checklist</button>
                        </div>
                        <template id="checklist-empty-form">
                            <div class="flex items-center justify-between p-4 bg-gray-100 dark:bg-gray-700 rounded-lg">
                                <div class="flex items-center space-x-4">
                                    {{ checklist_formset.empty_form.is_checked }}
                                    {{ checklist_formset.empty_form.description }}
                                </div>
                                {% if checklist_formset.can_delete %}
                                <div class="flex items-center">
                                    {{ checklist_formset.empty_form.DELETE }}
                                    <label for="{{ checklist_formset.empty_form.DELETE.id_for_label }}" class="ml-2 text-sm font-medium text-gray-700 dark:text-gray-300">Eliminar</label>
                                </div>
                                {% endif %}
                            </div>
                        </template>
                    </form>
                    {% else %}
                    <p class="text-sm text-gray-500">No hay eventos pr√≥ximos.</p>
                    {% endif %}
                </div>
                <div class="bg-gradient-to-r from-green-100 to-green-50 dark:from-green-800/30 dark:to-slate-800 p-5 rounded-2xl shadow-md border border-green-200 dark:border-green-700">
                                            <h2 class="text-2xl font-bold text-green-800 dark:text-green-400">Pr√≥ximos 5 Eventos</h2>
                    {% if other_upcoming_events %}
                    <ul class="space-y-4">
                        {% for event in other_upcoming_events %}
                        <li class="border-b border-gray-200 dark:border-gray-700 pb-4 last:border-b-0">
                            <h3 class="text-lg font-semibold text-gray-700">{{ event.titulo }}</h3>
                            <p class="text-sm text-gray-500">{{ event.fecha_inicio|date:"d/m/Y H:i" }}</p>
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p class="text-sm text-gray-500">No hay m√°s eventos pr√≥ximos.</p>
                    {% endif %}
                </div>
                  <!-- Attending Entity Stats -->
                            <div class="p-6 bg-gradient-to-br from-white to-slate-50 dark:from-slate-800 dark:to-slate-900 rounded-2xl shadow-lg border border-slate-100 dark:border-slate-700">
                                <div class="bg-dark dark:bg-slate-700 text-white px-5 py-3 font-semibold text-lg rounded-t-xl">
                                    <i class="fas fa-building mr-2"></i> Estad√≠sticas de Visitas por Entidad
                                </div>
                                <div class="p-5 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                    {% for entity in entity_stats %}
                                    <div class="bg-gray-100 dark:bg-gray-700 rounded-lg p-4 shadow">
                                        <h3 class="text-lg font-bold mb-2 dark:text-white">{{ entity.name }}</h3>
                                        <p class="text-sm text-gray-700 dark:text-gray-300">Visitas: {{ entity.visit_count }}</p>
                                    </div>
                                    {% empty %}
                                    <p class="col-span-4 text-center text-gray-500 dark:text-gray-400">No hay entidades registradas.</p>
                                    {% endfor %}
                                </div>
                            </div>
            </div>
        </div>

<div x-show="tab==='historial'" class="space-y-10">

    <!-- üîπ Solicitudes Recientes -->
    <div class="bg-gradient-to-br from-green-100 to-green-50 dark:from-green-900/40 dark:to-slate-900 p-6 rounded-2xl shadow-md border border-green-300 dark:border-green-700 hover:shadow-lg transition-all">
        <div class="flex items-center justify-between mb-3">
            <h2 class="text-xl font-semibold text-green-700 dark:text-green-400 flex items-center">
                <i class="fas fa-clipboard-list mr-2"></i> Solicitudes recientes
            </h2>
            <a href="{% url 'request:request_list' %}">
                <button class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white text-sm rounded-lg shadow transition-all">
                    Ver todas
                </button>
            </a>
        </div>

        <ul class="space-y-1 text-sm dark:text-gray-200">
            {% for r in recent_requests %}
            <li class="flex justify-between items-center p-2 bg-white/50 dark:bg-slate-800 rounded-lg hover:bg-green-50 dark:hover:bg-slate-700 transition-all">
                <span>
                    <strong>{{ r.user.username }}</strong> pidi√≥ 
                    <span class="font-semibold">{{ r.asset.name }}</span>
                </span>
                <span class="status {{ r.get_status_display|status_to_class }} font-semibold">
                    {{ r.get_status_display }}
                </span>
            </li>
            {% empty %}
            <p class="text-sm text-gray-500">No hay solicitudes recientes</p>
            {% endfor %}
        </ul>
    </div>

    <!-- üîπ √öltimos Pr√©stamos y Mantenimientos -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

        <!-- üü© √öltimos 10 Pr√©stamos -->
        <div class="rounded-2xl overflow-hidden shadow-md bg-white dark:bg-[#1b2432] border border-green-200 dark:border-gray-700 hover:shadow-lg transition-all">
            <div class="flex items-center justify-between bg-green-600 text-white px-5 py-3 font-semibold text-lg dark:bg-[#2b3548]">
                <h3><i class="fas fa-handshake mr-2"></i> √öltimos 10 Pr√©stamos</h3>
            </div>
            <div class="p-5">
                {% if last_10_loans %}
                <table id="loansTable" class="min-w-full text-sm divide-y divide-gray-200 dark:divide-gray-700">
                    <thead class="bg-green-50 text-gray-600 uppercase text-xs dark:bg-[#2b3548] dark:text-gray-200">
                        <tr>
                            <th class="px-6 py-3 text-left"><i class="fas fa-box-open mr-2"></i>Activo</th>
                            <th class="px-6 py-3 text-left"><i class="fas fa-user mr-2"></i>Usuario</th>
                            <th class="px-6 py-3 text-left"><i class="fas fa-calendar-alt mr-2"></i>Fecha Pr√©stamo</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200 dark:bg-slate-800 dark:divide-gray-700">
                        {% for loan in last_10_loans %}
                        <tr class="hover:bg-green-50 transition-all dark:hover:bg-[#253045]">
                            <td class="px-6 py-4 font-medium text-gray-900 dark:text-gray-100">{{ loan.asset.name }}</td>
                            <td class="px-6 py-4 text-gray-700 dark:text-gray-300">{{ loan.user.username }}</td>
                            <td class="px-6 py-4 text-gray-700 dark:text-gray-300">{{ loan.loan_date|date:"d/m/Y" }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p class="text-center text-gray-500 dark:text-gray-400">No hay pr√©stamos recientes.</p>
                {% endif %}
            </div>
        </div>

        <!-- üß∞ √öltimos 10 Mantenimientos -->
        <div class="rounded-2xl overflow-hidden shadow-md bg-white dark:bg-[#1b2432] border border-green-200 dark:border-gray-700 hover:shadow-lg transition-all">
            <div class="flex items-center justify-between bg-green-600 text-white px-5 py-3 font-semibold text-lg dark:bg-[#2b3548]">
                <h3><i class="fas fa-tools mr-2"></i> √öltimos 10 Mantenimientos</h3>
            </div>
            <div class="p-5">
                {% if last_10_maintenances %}
                <table id="maintenancesTable" class="min-w-full text-sm divide-y divide-gray-200 dark:divide-gray-700">
                    <thead class="bg-green-50 text-gray-600 uppercase text-xs dark:bg-[#2b3548] dark:text-gray-200">
                        <tr>
                            <th class="px-6 py-3 text-left"><i class="fas fa-box-open mr-2"></i>Activo</th>
                            <th class="px-6 py-3 text-left"><i class="fas fa-check-circle mr-2"></i>Estado</th>
                            <th class="px-6 py-3 text-left"><i class="fas fa-calendar-alt mr-2"></i>Fecha</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200 dark:bg-slate-800 dark:divide-gray-700">
                        {% for maintenance in last_10_maintenances %}
                        <tr class="hover:bg-green-50 transition-all dark:hover:bg-[#253045]">
                            <td class="px-6 py-4 font-medium text-gray-900 dark:text-gray-100">{{ maintenance.asset.name }}</td>
                            <td class="px-6 py-4 text-gray-700 dark:text-gray-300">{{ maintenance.status }}</td>
                            <td class="px-6 py-4 text-gray-700 dark:text-gray-300">{{ maintenance.created_at|date:"d/m/Y" }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p class="text-center text-gray-500 dark:text-gray-400">No hay mantenimientos recientes.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    let assetStatusChartInstance;
    let assetCategoryChartInstance;
    let entityChartInstance;
    let typeChartInstance;
    let loanStatusChartInstance;
    let loanUserChartInstance;

    function updateCharts() {
        if (assetStatusChartInstance) assetStatusChartInstance.update();
        if (assetCategoryChartInstance) assetCategoryChartInstance.update();
        if (entityChartInstance) entityChartInstance.update();
        if (typeChartInstance) typeChartInstance.update();
        if (loanStatusChartInstance) loanStatusChartInstance.update();
        if (loanUserChartInstance) loanUserChartInstance.update();
    }

    // Data from Django for Event Charts
    const entityChartData = JSON.parse(document.getElementById('entity_chart_data').textContent);
    const typeChartData = JSON.parse(document.getElementById('type_chart_data').textContent);
    const statusSummaryData = JSON.parse(document.getElementById('status_summary_data').textContent);
    const userSummaryData = JSON.parse(document.getElementById('user_summary_data').textContent);

  const STORAGE_KEY = 'dashboard_preferences_v1'; // cambia versi√≥n si actualizas esquema
  const chartsContainer = document.getElementById('chartsContainer');
  const toggles = document.querySelectorAll('.chart-toggle');
  const saveBtn = document.getElementById('saveDashboardBtn');
  const resetBtn = document.getElementById('resetDashboardBtn');

  // Inicializar Sortable (drag & drop)
  const sortable = Sortable.create(chartsContainer, {
    handle: '.chart-card', // el usuario puede arrastrar por cualquier parte de la tarjeta
    animation: 150,
    onEnd: saveToLocalStorageDebounced // guardar orden cuando termine de arrastrar
  });

  // ---- Helpers ----
  function getCurrentState() {
    // estado = { order: [...ids], visible: {id: true/false} }
    const order = Array.from(chartsContainer.querySelectorAll('.chart-card')).map(c => c.dataset.id);
    const visible = {};
    order.forEach(id => {
      const el = document.getElementById(id);
      visible[id] = !el.classList.contains('hidden'); // usamos class hidden para ocultar
    });
    return { order, visible };
  }

  function applyState(state) {
    // 1) Orden: reordenar DOM seg√∫n state.order
    if (state.order && Array.isArray(state.order)) {
      state.order.forEach(id => {
        const el = document.querySelector(`[data-id="${id}"]`);
        if (el) chartsContainer.appendChild(el);
      });
    }

    // 2) Visibilidad: mostrar/ocultar y actualizar checkboxes
    document.querySelectorAll('.chart-card').forEach(card => {
      const id = card.dataset.id;
      const shouldShow = state.visible ? !!state.visible[id] : true;
      setChartVisibility(id, shouldShow, /*animate=*/true);
      // actualizar checkbox correspondiente
      const cb = document.querySelector(`.chart-toggle[data-chart="${id}"]`);
      if (cb) cb.checked = shouldShow;
    });
  }

  function setChartVisibility(id, show, animate = true) {
    const el = document.getElementById(id);
    if (!el) return;
    if (show) {
      el.classList.remove('hidden', 'opacity-0', 'scale-95');
      if (animate) {
        // fuerza reflow para que la transici√≥n funcione
        void el.offsetWidth;
        el.classList.remove('translate-y-2');
      }
    } else {
      if (animate) {
        el.classList.add('opacity-0', 'scale-95');
        setTimeout(() => el.classList.add('hidden'), 250); // coincide con transition duration
      } else {
        el.classList.add('hidden');
      }
    }
  }

  // ---- Local storage ----
  function saveToLocalStorage() {
    const state = getCurrentState();
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  }

  // Debounced save to avoid many writes during dragging
  let saveTimeout = null;
  function saveToLocalStorageDebounced() {
    if (saveTimeout) clearTimeout(saveTimeout);
    saveTimeout = setTimeout(() => {
      saveToLocalStorage();
    }, 250);
  }

  function loadFromLocalStorage() {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return null;
    try {
      return JSON.parse(raw);
    } catch (e) {
      console.warn('dashboard: prefs parse error', e);
      return null;
    }
  }

  function resetToDefaults() {
    // default: show all, original order = initial DOM order
    document.querySelectorAll('.chart-card').forEach(card => {
      setChartVisibility(card.dataset.id, true, false);
    });
    // optionally restore default order: no action if you want original HTML order
    // remove stored prefs
    localStorage.removeItem(STORAGE_KEY);
    // reload page to reflect order (optional)
    window.location.reload();
  }

  // ---- Event handlers: toggles ----
  toggles.forEach(cb => {
    cb.addEventListener('change', (e) => {
      const id = cb.dataset.chart;
      setChartVisibility(id, cb.checked, true);
      saveToLocalStorageDebounced();
    });
  });

  // Save button -> also optionally send to server
  saveBtn.addEventListener('click', () => {
    saveToLocalStorage();
    // Opcional: enviar al servidor (ver secci√≥n servidor m√°s abajo)
    // saveToServer();
    showToast('Preferencias guardadas localmente');
  });

  resetBtn.addEventListener('click', () => {
    if (!confirm('Restablecer el tablero a la configuraci√≥n por defecto?')) return;
    resetToDefaults();
  });

  // Small toast for UX
  function showToast(msg) {
    const t = document.createElement('div');
    t.innerText = msg;
    t.className = 'fixed bottom-6 right-6 bg-black/80 text-white px-4 py-2 rounded shadow-lg';
    document.body.appendChild(t);
    setTimeout(() => {
      t.classList.add('opacity-0');
      setTimeout(() => t.remove(), 400);
    }, 1400);
  }

    // Asset Status Chart (Doughnut Chart)
    const assetStatusCtx = document.getElementById('assetStatusChart').getContext('2d');
    const gradient = assetStatusCtx.createLinearGradient(0, 0, 0, 400);
    gradient.addColorStop(0, '#10B981');
    gradient.addColorStop(1, '#2563EB');

    assetStatusChartInstance = new Chart(assetStatusCtx, {
        type: 'doughnut',
        data: {
            labels: {{ asset_status_labels|safe }},
            datasets: [{
                data: {{ asset_status_data|safe }},
                backgroundColor: [
                    '#10B981', // primary (Disponible)
                    '#2563EB', // new blue (En uso)
                    '#FBBF24', // new orange (En mantenimiento)
                ],
                borderWidth: 2,
                borderColor: document.documentElement.classList.contains('dark') ? '#1e293b' : '#fff',
                hoverBorderColor: '#10B981',
                hoverOffset: 4
            }]
        },
        options: {
            responsive: true,
            aspectRatio: 2, // Hace el gr√°fico m√°s ancho que alto
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        color: document.documentElement.classList.contains('dark') ? '#cbd5e1' : '#4b5563',
                    }
                },
                title: {
                    display: false,
                }
            }
        }
    });

    // Assets by Category Chart (Bar Chart)
    const assetCategoryCtx = document.getElementById('assetCategoryChart').getContext('2d');
    assetCategoryChartInstance = new Chart(assetCategoryCtx, {
        type: 'bar',
        data: {
            labels: {{ asset_category_labels|safe }},
            datasets: [{
                label: 'N√∫mero de Activos',
                data: {{ asset_category_data|safe }},
                backgroundColor: gradient,
                borderColor: document.documentElement.classList.contains('dark') ? '#1e293b' : '#fff',
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: false,
                },
                title: {
                    display: false,
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        color: document.documentElement.classList.contains('dark') ? '#cbd5e1' : '#4b5563',
                        stepSize: 1
                    }
                },
                x: {
                    ticks: {
                        color: document.documentElement.classList.contains('dark') ? '#cbd5e1' : '#4b5563',
                    }
                }
            }
        }
    });

    // Chart: Events per Entity (Bar Chart)
    const ctxEntity = document.getElementById('entityChart').getContext('2d');
    entityChartInstance = new Chart(ctxEntity, {
        type: 'bar',
        data: {
            labels: entityChartData.labels,
            datasets: [{
                label: 'N√∫mero de Eventos',
                data: entityChartData.data,
                backgroundColor: document.documentElement.classList.contains('dark') ? 'rgba(59, 130, 246, 0.7)' : 'rgba(59, 130, 246, 0.5)',
                borderColor: document.documentElement.classList.contains('dark') ? 'rgba(59, 130, 246, 1)' : 'rgba(59, 130, 246, 1)',
                borderWidth: 1
            }]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        color: document.documentElement.classList.contains('dark') ? '#cbd5e1' : '#4b5563',
                        stepSize: 1
                    }
                },
                x: {
                    ticks: {
                        color: document.documentElement.classList.contains('dark') ? '#cbd5e1' : '#4b5563',
                    }
                }
            },
            responsive: true,
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });

    // Chart: Event Type Distribution (Pie Chart)
    const ctxType = document.getElementById('typeChart').getContext('2d');
    typeChartInstance = new Chart(ctxType, {
        type: 'pie',
        data: {
            labels: typeChartData.labels,
            datasets: [{
                label: 'Distribuci√≥n',
                data: typeChartData.data,
                backgroundColor: [
                    document.documentElement.classList.contains('dark') ? 'rgba(239, 68, 68, 0.7)' : 'rgba(239, 68, 68, 0.5)',
                    document.documentElement.classList.contains('dark') ? 'rgba(59, 130, 246, 0.7)' : 'rgba(59, 130, 246, 0.5)',
                    document.documentElement.classList.contains('dark') ? 'rgba(245, 158, 11, 0.7)' : 'rgba(245, 158, 11, 0.5)',
                    document.documentElement.classList.contains('dark') ? 'rgba(16, 185, 129, 0.7)' : 'rgba(16, 185, 129, 0.5)',
                    document.documentElement.classList.contains('dark') ? 'rgba(139, 92, 246, 0.7)' : 'rgba(139, 92, 246, 0.5)',
                ],
                borderColor: [
                    document.documentElement.classList.contains('dark') ? 'rgba(239, 68, 68, 1)' : 'rgba(239, 68, 68, 1)',
                    document.documentElement.classList.contains('dark') ? 'rgba(59, 130, 246, 1)' : 'rgba(59, 130, 246, 1)',
                    document.documentElement.classList.contains('dark') ? 'rgba(245, 158, 11, 1)' : 'rgba(245, 158, 11, 1)',
                    document.documentElement.classList.contains('dark') ? 'rgba(16, 185, 129, 1)' : 'rgba(16, 185, 129, 1)',
                    document.documentElement.classList.contains('dark') ? 'rgba(139, 92, 246, 1)' : 'rgba(139, 92, 246, 1)',
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                       color: document.documentElement.classList.contains('dark') ? '#cbd5e1' : '#4b5563',
                    }
                }
            }
        }
    });

    // Chart: Loan Status (Pie Chart)
    if (statusSummaryData.length > 0) {
        const loanStatusCtx = document.getElementById('loanStatusCanvas').getContext('2d');
        loanStatusChartInstance = new Chart(loanStatusCtx, {
          type: 'pie',
          data: {
            labels: statusSummaryData.map(d => d.status),
            datasets: [{ data: statusSummaryData.map(d => d.total) }]
          }
        });
    }

    // Chart: Loans by User (Bar Chart)
    if (userSummaryData.length > 0) {
        const loanUserCtx = document.getElementById('loanUserCanvas').getContext('2d');
        loanUserChartInstance = new Chart(loanUserCtx, {
          type: 'bar',
          data: {
            labels: userSummaryData.map(d => d.user__username),
            datasets: [{ data: userSummaryData.map(d => d.total) }]
          }
        });
    }

  // ---- Initialize: apply saved state if exists ----
  const saved = loadFromLocalStorage();
  if (saved) {
    applyState(saved);
  } else {
    // no prefs -> ensure all visible and in default order
    document.querySelectorAll('.chart-toggle').forEach(cb => cb.checked = true);
  }

  // Optional: Save automatically on unload (helps preserve order after drag)
  window.addEventListener('beforeunload', saveToLocalStorage);

  // ---- Optional: function to save to server (AJAX, needs endpoint) ----
  async function saveToServer() {
    // Solo si usuario autenticado y quieres persistencia por usuario
    const state = getCurrentState();
    try {
      const csrftoken = getCookie('csrftoken');
      const res = await fetch('/api/dashboard/preferences/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrftoken
        },
        body: JSON.stringify(state)
      });
      if (!res.ok) throw new Error('Network response was not ok');
      showToast('Preferencias guardadas en el servidor');
    } catch (err) {
      console.error('saveToServer error', err);
      showToast('Error guardando en servidor');
    }
  }

  // small helper to get cookie CSRF
  function getCookie(name) {
    const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
    if (match) return decodeURIComponent(match[2]);
    return null;
  }

});
</script>
{% endblock %}

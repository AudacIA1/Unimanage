{% extends 'base.html' %}
{% load role_tags %}

{% block title %}Solicitudes de préstamo{% endblock %}

{% block content %}
<div class="p-6 text-gray-100 min-h-screen bg-[#0f1623]">
  {% in_group user "Administrador" as is_admin %}
  
  <div class="max-w-7xl mx-auto">
    {% if is_admin %}
      <h1 class="text-3xl font-bold mb-2 text-white">Solicitudes por Aprobar</h1>
      <p class="text-sm text-gray-400 mb-6">Vista del administrador</p>
    {% else %}
      <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold text-white">Mis Solicitudes</h1>
        <button id="open-modal-button" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">+ Nueva solicitud</button>
      </div>
    {% endif %}

    <!-- Tabla de solicitudes -->
    <div class="overflow-x-auto rounded-2xl shadow-lg bg-[#1b2432] border border-gray-700">
      <table class="min-w-full text-sm">
        <thead class="bg-[#2b3548] text-gray-200 uppercase text-xs">
          <tr>
            <th class="p-3 text-left">Activo</th>
            <th class="p-3 text-left">Usuario</th>
            <th class="p-3 text-left">Estado</th>
            <th class="p-3 text-left">Fecha de inicio</th>
            <th class="p-3 text-left">Fecha de fin</th>
            <th class="p-3 text-left">Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for r in requests %}
          <tr class="border-t border-gray-700 hover:bg-[#253045] transition">
            <td class="p-3">{{ r.asset.name }}</td>
            <td class="p-3">{{ r.user.username }}</td>
            <td class="p-3">
              {% if r.status == "approved" %}
                <span class="text-green-400 font-semibold">Aprobada</span>
              {% elif r.status == "rejected" %}
                <span class="text-red-400 font-semibold">Rechazada</span>
              {% else %}
                <span class="text-yellow-400 font-semibold">Pendiente</span>
              {% endif %}
            </td>
            <td class="p-3">{{ r.start_date|date:"d/m/Y" }}</td>
            <td class="p-3">{{ r.end_date|date:"d/m/Y" }}</td>
            <td class="p-3 space-x-2">
              {% if is_admin %}
                {% if r.status == 'pending' %}
                  <a href="{% url 'request:request_approve' r.id %}" class="text-green-500 hover:text-green-400 font-semibold">Aprobar</a>
                  <a href="{% url 'request:request_reject' r.id %}" class="text-yellow-500 hover:text-yellow-400 font-semibold">Rechazar</a>
                {% endif %}
                <a href="{% url 'request:request_delete' r.id %}" class="text-red-500 hover:text-red-400 font-semibold">Borrar</a>
              {% endif %}
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="6" class="p-4 text-center text-gray-400">No hay solicitudes registradas.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>


{% block extra_scripts %}
<script>
  const openModalButton = document.getElementById('open-modal-button');
  const closeModalButton = document.getElementById('close-modal-button');
  const modal = document.getElementById('request-modal');

  if (openModalButton) {
    openModalButton.addEventListener('click', () => {
      modal.classList.remove('hidden');
    });
  }

  closeModalButton.addEventListener('click', () => {
    modal.classList.add('hidden');
  });

  document.getElementById('asset-search').addEventListener('input', function() {
      const query = this.value;
      const startDate = document.getElementById('start_date').value;
      const endDate = document.getElementById('end_date').value;

      if (query.length < 2) {
          document.getElementById('asset-results').classList.add('hidden');
          return;
      }

      if (!startDate || !endDate) {
        alert('Por favor, selecciona un rango de fechas.');
        return;
      }

      fetch(`/solicitudes/buscar/?q=${query}&start_date=${startDate}&end_date=${endDate}`)
        .then(res => res.json())
        .then(data => {
            const list = document.getElementById('asset-results');
            list.innerHTML = '';
            if (data.results.length > 0) {
                data.results.forEach(a => {
                    const item = document.createElement('li');
                    item.classList.add('p-2', 'hover:bg-gray-100', 'cursor-pointer');
                    item.textContent = `${a.name} — ${a.status}`;
                    item.onclick = () => selectAsset(a);
                    list.appendChild(item);
                });
                list.classList.remove('hidden');
            } else {
                list.classList.add('hidden');
            }
        });
  });

  function selectAsset(asset) {
      document.getElementById('asset_id').value = asset.id;
      document.getElementById('asset-results').classList.add('hidden');
      const info = document.getElementById('asset-info');
      info.innerHTML = `
        <h4 class="font-semibold">${asset.name}</h4>
        <p>Estado: <span class="font-medium">${asset.status}</span></p>
        <p>Categoría: ${asset.category}</p>
        <p>Ubicación: ${asset.location}</p>
      `;
      info.classList.remove('hidden');
  }

  document.getElementById('request-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    fetch("{% url 'request:request_create' %}", {
      method: 'POST',
      body: formData,
      headers: {
        'X-CSRFToken': '{{ csrf_token }}'
      }
    })
    .then(res => res.json())
    .then(data => {
      if (data.status === 'success') {
        modal.classList.add('hidden');
        alert(data.message);
        location.reload();
      } else {
        alert(data.message);
      }
    });
  });
</script>
{% endblock %}
{% endblock %}

{% extends 'base.html' %}
{% load role_tags %}

{% block title %}Solicitudes de préstamo{% endblock %}

{% block content %}
<div class="container mx-auto mt-8">
  {% in_group user "Administrador" as is_admin %}
  {% if is_admin %}
    <h1 class="text-2xl font-bold mb-4">Solicitudes por Aprobar</h1>
    <p class="text-sm text-gray-600 mb-4">Vista del administrador</p>
  {% else %}
    <h1 class="text-2xl font-bold mb-4">Mis Solicitudes</h1>
    <button id="open-modal-button" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 mb-4 inline-block">Realizar nueva solicitud</button>
  {% endif %}

  <!-- Modal -->
  <div id="request-modal" class="fixed inset-0 bg-gray-800 bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-white p-6 rounded shadow-lg w-1/2">
      <h2 class="text-xl font-bold mb-4">Nueva solicitud de préstamo</h2>
      <form id="request-form" method="post">
        {% csrf_token %}
        <div class="grid grid-cols-2 gap-4 mb-4">
          <div>
            <label for="start_date" class="block text-sm font-medium">Fecha de inicio</label>
            <input type="datetime-local" id="start_date" name="start_date" class="border p-2 w-full rounded">
          </div>
          <div>
            <label for="end_date" class="block text-sm font-medium">Fecha de fin</label>
            <input type="datetime-local" id="end_date" name="end_date" class="border p-2 w-full rounded">
          </div>
        </div>

        <div class="mb-4">
          <label for="asset-search" class="block text-sm font-medium">Buscar activo</label>
          <input type="text" id="asset-search" class="border p-2 w-full rounded" placeholder="Escribe el nombre del activo...">
          <ul id="asset-results" class="mt-2 border rounded bg-white max-h-40 overflow-auto hidden"></ul>
        </div>

        <input type="hidden" name="asset_id" id="asset_id">
        <div id="asset-info" class="hidden mt-4 bg-gray-50 p-4 rounded"></div>

        <label for="reason" class="block mb-2">Motivo</label>
        <textarea name="reason" id="reason" rows="4" class="w-full p-2 border rounded mb-4"></textarea>

        <div class="flex justify-end">
          <button type="button" id="close-modal-button" class="bg-gray-400 text-white px-4 py-2 rounded mr-2">Cancelar</button>
          <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">Enviar solicitud</button>
        </div>
      </form>
    </div>
  </div>

  <table class="min-w-full bg-white shadow rounded">
    <thead>
      <tr>
        <th class="p-2 text-left">Activo</th>
        <th class="p-2 text-left">Usuario</th>
        <th class="p-2 text-left">Estado</th>
        <th class="p-2 text-left">Fecha de inicio</th>
        <th class="p-2 text-left">Fecha de fin</th>
        <th class="p-2 text-left">Acciones</th>
      </tr>
    </thead>
    <tbody>
      {% for r in requests %}
      <tr class="border-t">
        <td class="p-2">{{ r.asset.name }}</td>
        <td class="p-2">{{ r.user.username }}</td>
        <td class="p-2">{{ r.get_status_display }}</td>
        <td class="p-2">{{ r.start_date|date:"d/m/Y" }}</td>
        <td class="p-2">{{ r.end_date|date:"d/m/Y" }}</td>
        <td class="p-2">
          {% if is_admin %}
            {% if r.status == 'pending' %}
              <a href="{% url 'request:request_approve' r.id %}" class="text-green-600">Aprobar</a> |
              <a href="{% url 'request:request_reject' r.id %}" class="text-red-600">Rechazar</a> |
            {% endif %}
            <a href="{% url 'request:request_delete' r.id %}" class="text-red-600">Borrar</a>
          {% endif %}
        </td>
      </tr>
      {% empty %}
      <tr><td colspan="5" class="p-4 text-center text-gray-500">No hay solicitudes registradas.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

{% block extra_scripts %}
<script>
  const openModalButton = document.getElementById('open-modal-button');
  const closeModalButton = document.getElementById('close-modal-button');
  const modal = document.getElementById('request-modal');

  if (openModalButton) {
    openModalButton.addEventListener('click', () => {
      modal.classList.remove('hidden');
    });
  }

  closeModalButton.addEventListener('click', () => {
    modal.classList.add('hidden');
  });

  document.getElementById('asset-search').addEventListener('input', function() {
      const query = this.value;
      const startDate = document.getElementById('start_date').value;
      const endDate = document.getElementById('end_date').value;

      if (query.length < 2) {
          document.getElementById('asset-results').classList.add('hidden');
          return;
      }

      if (!startDate || !endDate) {
        alert('Por favor, selecciona un rango de fechas.');
        return;
      }

      fetch(`/solicitudes/buscar/?q=${query}&start_date=${startDate}&end_date=${endDate}`)
        .then(res => res.json())
        .then(data => {
            const list = document.getElementById('asset-results');
            list.innerHTML = '';
            if (data.results.length > 0) {
                data.results.forEach(a => {
                    const item = document.createElement('li');
                    item.classList.add('p-2', 'hover:bg-gray-100', 'cursor-pointer');
                    item.textContent = `${a.name} — ${a.status}`;
                    item.onclick = () => selectAsset(a);
                    list.appendChild(item);
                });
                list.classList.remove('hidden');
            } else {
                list.classList.add('hidden');
            }
        });
  });

  function selectAsset(asset) {
      document.getElementById('asset_id').value = asset.id;
      document.getElementById('asset-results').classList.add('hidden');
      const info = document.getElementById('asset-info');
      info.innerHTML = `
        <h4 class="font-semibold">${asset.name}</h4>
        <p>Estado: <span class="font-medium">${asset.status}</span></p>
        <p>Categoría: ${asset.category}</p>
        <p>Ubicación: ${asset.location}</p>
      `;
      info.classList.remove('hidden');
  }

  document.getElementById('request-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    fetch("{% url 'request:request_create' %}", {
      method: 'POST',
      body: formData,
      headers: {
        'X-CSRFToken': '{{ csrf_token }}'
      }
    })
    .then(res => res.json())
    .then(data => {
      if (data.status === 'success') {
        modal.classList.add('hidden');
        alert(data.message);
        location.reload();
      } else {
        alert(data.message);
      }
    });
  });
</script>
{% endblock %}
{% endblock %}

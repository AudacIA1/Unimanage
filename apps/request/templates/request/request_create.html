{% extends 'base.html' %}
{% block title %}Nueva solicitud{% endblock %}
{% block content %}
<div class="max-w-xl mx-auto mt-10 bg-white p-6 shadow rounded">
  <h2 class="text-xl font-bold mb-4">Nueva solicitud de préstamo</h2>
  <form method="post">
    {% csrf_token %}
    <div class="mb-4">
      <label for="asset-search" class="block text-sm font-medium">Buscar activo</label>
      <input type="text" id="asset-search" class="border p-2 w-full rounded" placeholder="Escribe el nombre del activo...">
      <ul id="asset-results" class="mt-2 border rounded bg-white max-h-40 overflow-auto hidden"></ul>
    </div>

    <input type="hidden" name="asset_id" id="asset_id">
    <div id="asset-info" class="hidden mt-4 bg-gray-50 p-4 rounded"></div>

    <script>
    document.getElementById('asset-search').addEventListener('input', function() {
        const query = this.value;
        if (query.length < 2) {
            document.getElementById('asset-results').classList.add('hidden');
            return;
        }
        fetch(`/solicitudes/buscar/?q=${query}`)
          .then(res => res.json())
          .then(data => {
              const list = document.getElementById('asset-results');
              list.innerHTML = '';
              if (data.results.length > 0) {
                  data.results.forEach(a => {
                      const item = document.createElement('li');
                      item.classList.add('p-2', 'hover:bg-gray-100', 'cursor-pointer');
                      item.textContent = `${a.name} — ${a.status}`;
                      item.onclick = () => selectAsset(a);
                      list.appendChild(item);
                  });
                  list.classList.remove('hidden');
              } else {
                  list.classList.add('hidden');
              }
          });
    });

    function selectAsset(asset) {
        document.getElementById('asset_id').value = asset.id;
        document.getElementById('asset-results').classList.add('hidden');
        const info = document.getElementById('asset-info');
        info.innerHTML = `
          <h4 class="font-semibold">${asset.name}</h4>
          <p>Estado: <span class="font-medium">${asset.status}</span></p>
          <p>Categoría: ${asset.category}</p>
          <p>Ubicación: ${asset.location}</p>
        `;
        info.classList.remove('hidden');
    }
    </script>

    <label for="reason" class="block mb-2">Motivo</label>
    <textarea name="reason" id="reason" rows="4" class="w-full p-2 border rounded mb-4"></textarea>

    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">Enviar solicitud</button>
  </form>
</div>
{% endblock %}
